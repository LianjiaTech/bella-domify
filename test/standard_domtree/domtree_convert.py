import json
import os
import uuid

from fastapi.encoders import jsonable_encoder

from doc_parser.dom_parser.converter import Converter
from doc_parser.dom_parser.domtree.domtree import DomTreeModel
from server.protocol.standard_domtree import StandardDomTree, SourceFile
from test import TEST_PATH

file_path = os.path.join(TEST_PATH, "document")



def test_domtree_convert():
    file_name = '英文论文Demo_前3页.pdf'
    # 读取本地文件
    converter = Converter(os.path.join(file_path, file_name))
    dom_tree = converter.dom_tree_parse(
        start=0, end=3,
        remove_watermark=True,
        debug=False,
        debug_file_name=os.path.join(file_path, file_name),
        parse_stream_table=False
    )
    file_info = {
        "id": uuid.uuid4().hex,
        "filename": file_name,
        "type": "pdf",
        "mime_type": "application/pdf"
    }
    dom_tree_json = jsonable_encoder(DomTreeModel(dom_tree=dom_tree))
    standard_dom_tree = StandardDomTree.from_domtree_dict(dom_tree_json, file_info = file_info)
    json_compatible_data = jsonable_encoder(standard_dom_tree.root)
    print(json.dumps(json_compatible_data, ensure_ascii=False))

    # 加载test/standard_domtree预期的JSON结果文件test/standard_domtree/result/英文论文Demo_前3页.json 比较 json.dumps(json_compatible_data, ensure_ascii=False)结果是否一致
    result_correct_json = ""
    result_file_path = os.path.join(TEST_PATH, "standard_domtree", "result", "英文论文Demo_前3页.json")
    with open(result_file_path, "r", encoding="utf-8") as f:
        result_correct_json = f.read()

    # 比较生成的结果与预期结果是否一致
    current_result = json.dumps(json_compatible_data, ensure_ascii=False)
    # 将两个JSON字符串解析为Python对象进行比较，避免格式差异导致的误判
    assert json.loads(current_result) == json.loads(result_correct_json), "生成的DOM树与预期结果不一致"
    print("测试通过：生成的DOM树与预期结果一致")



text_dom_tree_json = '{"root": {"child": [{"child": [], "order_num": null, "element": {"layout_type": "Text", "bbox": [0.0, 1.0, 0.0, 1.0], "metadata": null, "text": "这是一个示例，这是一个示例\\r\\n\\r\\n这是一个示例，这是一个示例\\r\\n\\r\\n这是一个示例，这是一个示例\\r\\n\\r\\n\\r\\n\\r\\n这是一个示例，这是一个示例\\r\\n这是一个示例，这是一个示例\\r\\n这是一个示例，这是一个示例\\r\\n\\r\\n\\r\\n这是一个示例，这是一个示例\\r\\n\\r\\n", "page_num": 0, "block_type": "text", "image_link": null, "image_ocr_result": null}}], "order_num": null, "element": null}}'
def test_txt_domtree_convert():
    file_name = 'demo.txt'
    stream = load_test_file(file_name)
    converter = TxtConverter(stream)
    domtree = converter.dom_tree_parse()
    dom_tree_json = jsonable_encoder(domtree)
    print(json.dumps(dom_tree_json, ensure_ascii=False))
    assert json.dumps(dom_tree_json, ensure_ascii=False) == text_dom_tree_json, "生成的DOM树与预期结果不一致"


xls_dom_tree_json = '{"root": {"child": [{"child": [], "order_num": "1", "element": {"block_type": "table", "page_num": [0], "layout_type": "Table", "bbox": [0.0, 0.0, 70.0, 40.0], "rows": [{"cells": [{"order_num": "1.1-1-1-1", "text": "", "start_row": 1, "end_row": 1, "start_col": 1, "end_col": 1}, {"order_num": "1.1-1-2-2", "text": "贝壳", "start_row": 1, "end_row": 1, "start_col": 2, "end_col": 2}, {"order_num": "1.1-1-3-3", "text": "阿里", "start_row": 1, "end_row": 1, "start_col": 3, "end_col": 3}, {"order_num": "1.1-1-4-4", "text": "unstructured", "start_row": 1, "end_row": 1, "start_col": 4, "end_col": 4}, {"order_num": "1.1-1-5-5", "text": "chunkr", "start_row": 1, "end_row": 1, "start_col": 5, "end_col": 5}, {"order_num": "1.1-1-6-6", "text": "庖丁", "start_row": 1, "end_row": 1, "start_col": 6, "end_col": 6}, {"order_num": "1.1-1-7-7", "text": "surya", "start_row": 1, "end_row": 1, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.2-2-1-1", "text": "block切分准确率", "start_row": 2, "end_row": 2, "start_col": 1, "end_col": 1}, {"order_num": "1.2-2-2-2", "text": "0.96  (425 / 442)", "start_row": 2, "end_row": 2, "start_col": 2, "end_col": 2}, {"order_num": "1.2-2-3-3", "text": "0.96  (427 / 442)", "start_row": 2, "end_row": 2, "start_col": 3, "end_col": 3}, {"order_num": "1.2-2-4-4", "text": "0.78  (353 / 442)", "start_row": 2, "end_row": 2, "start_col": 4, "end_col": 4}, {"order_num": "1.2-2-5-5", "text": "0.70  (313 / 442)", "start_row": 2, "end_row": 2, "start_col": 5, "end_col": 5}, {"order_num": "1.2-2-6-6", "text": "0.94  (419 / 442)", "start_row": 2, "end_row": 2, "start_col": 6, "end_col": 6}, {"order_num": "1.2-2-7-7", "text": "<<.053", "start_row": 2, "end_row": 2, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.3-3-1-1", "text": "版面元素准确率", "start_row": 3, "end_row": 3, "start_col": 1, "end_col": 1}, {"order_num": "1.3-3-2-2", "text": "0.70  (311.5 / 442)", "start_row": 3, "end_row": 3, "start_col": 2, "end_col": 2}, {"order_num": "1.3-3-3-3", "text": "0.72  (318.0 / 442)", "start_row": 3, "end_row": 3, "start_col": 3, "end_col": 3}, {"order_num": "1.3-3-4-4", "text": "0.48  (213.6 / 442)", "start_row": 3, "end_row": 3, "start_col": 4, "end_col": 4}, {"order_num": "1.3-3-5-5", "text": "0.46  (205.0 / 442)", "start_row": 3, "end_row": 3, "start_col": 5, "end_col": 5}, {"order_num": "1.3-3-6-6", "text": "0.38  (170.0 / 442)", "start_row": 3, "end_row": 3, "start_col": 6, "end_col": 6}, {"order_num": "1.3-3-7-7", "text": "0.52  (230.2 / 442)", "start_row": 3, "end_row": 3, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.4-4-1-1", "text": "层级结构准确率", "start_row": 4, "end_row": 4, "start_col": 1, "end_col": 1}, {"order_num": "1.4-4-2-2", "text": "0.80  (336 / 422)", "start_row": 4, "end_row": 4, "start_col": 2, "end_col": 2}, {"order_num": "1.4-4-3-3", "text": "0.77  (327 / 422)", "start_row": 4, "end_row": 4, "start_col": 3, "end_col": 3}, {"order_num": "1.4-4-4-4", "text": "0.27  (112 / 422)", "start_row": 4, "end_row": 4, "start_col": 4, "end_col": 4}, {"order_num": "1.4-4-5-5", "text": "0.00  (0 / 422)", "start_row": 4, "end_row": 4, "start_col": 5, "end_col": 5}, {"order_num": "1.4-4-6-6", "text": "0.56  (237 / 422)", "start_row": 4, "end_row": 4, "start_col": 6, "end_col": 6}, {"order_num": "1.4-4-7-7", "text": "-", "start_row": 4, "end_row": 4, "start_col": 7, "end_col": 7}]}]}}, {"child": [], "order_num": "1", "element": {"block_type": "table", "page_num": [1], "layout_type": "Table", "bbox": [0.0, 0.0, 70.0, 130.0], "rows": [{"cells": [{"order_num": "1.1-1-1-1", "text": "", "start_row": 1, "end_row": 1, "start_col": 1, "end_col": 1}, {"order_num": "1.1-1-2-2", "text": "贝壳", "start_row": 1, "end_row": 1, "start_col": 2, "end_col": 2}, {"order_num": "1.1-1-3-3", "text": "阿里", "start_row": 1, "end_row": 1, "start_col": 3, "end_col": 3}, {"order_num": "1.1-1-4-4", "text": "unstructured", "start_row": 1, "end_row": 1, "start_col": 4, "end_col": 4}, {"order_num": "1.1-1-5-5", "text": "chunkr", "start_row": 1, "end_row": 1, "start_col": 5, "end_col": 5}, {"order_num": "1.1-1-6-6", "text": "庖丁", "start_row": 1, "end_row": 1, "start_col": 6, "end_col": 6}, {"order_num": "1.1-1-7-7", "text": "surya", "start_row": 1, "end_row": 1, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.2-2-1-1", "text": "label_Text", "start_row": 2, "end_row": 2, "start_col": 1, "end_col": 1}, {"order_num": "1.2-2-2-2", "text": "0.96  (143.5 / 150)", "start_row": 2, "end_row": 2, "start_col": 2, "end_col": 2}, {"order_num": "1.2-2-3-3", "text": "0.97  (145.0 / 150)", "start_row": 2, "end_row": 2, "start_col": 3, "end_col": 3}, {"order_num": "1.2-2-4-4", "text": "0.92  (138.7 / 150)", "start_row": 2, "end_row": 2, "start_col": 4, "end_col": 4}, {"order_num": "1.2-2-5-5", "text": "0.90  (135.0 / 150)", "start_row": 2, "end_row": 2, "start_col": 5, "end_col": 5}, {"order_num": "1.2-2-6-6", "text": "0.97  (146.0 / 150)", "start_row": 2, "end_row": 2, "start_col": 6, "end_col": 6}, {"order_num": "1.2-2-7-7", "text": "0.95  (143.2 / 150)", "start_row": 2, "end_row": 2, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.3-3-1-1", "text": "label_Title", "start_row": 3, "end_row": 3, "start_col": 1, "end_col": 1}, {"order_num": "1.3-3-2-2", "text": "0.86  (87.0 / 101)", "start_row": 3, "end_row": 3, "start_col": 2, "end_col": 2}, {"order_num": "1.3-3-3-3", "text": "0.80  (81.0 / 101)", "start_row": 3, "end_row": 3, "start_col": 3, "end_col": 3}, {"order_num": "1.3-3-4-4", "text": "0.59  (59.3 / 101)", "start_row": 3, "end_row": 3, "start_col": 4, "end_col": 4}, {"order_num": "1.3-3-5-5", "text": "0.49  (49.0 / 101)", "start_row": 3, "end_row": 3, "start_col": 5, "end_col": 5}, {"order_num": "1.3-3-6-6", "text": "0.00  (0.0 / 101)", "start_row": 3, "end_row": 3, "start_col": 6, "end_col": 6}, {"order_num": "1.3-3-7-7", "text": "0.57  (58.0 / 101)", "start_row": 3, "end_row": 3, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.4-4-1-1", "text": "label_List", "start_row": 4, "end_row": 4, "start_col": 1, "end_col": 1}, {"order_num": "1.4-4-2-2", "text": "0.00  (0.0 / 84)", "start_row": 4, "end_row": 4, "start_col": 2, "end_col": 2}, {"order_num": "1.4-4-3-3", "text": "0.00  (0.0 / 84)", "start_row": 4, "end_row": 4, "start_col": 3, "end_col": 3}, {"order_num": "1.4-4-4-4", "text": "0.00  (0.0 / 84)", "start_row": 4, "end_row": 4, "start_col": 4, "end_col": 4}, {"order_num": "1.4-4-5-5", "text": "0.04  (3.0 / 84)", "start_row": 4, "end_row": 4, "start_col": 5, "end_col": 5}, {"order_num": "1.4-4-6-6", "text": "0.00  (0.0 / 84)", "start_row": 4, "end_row": 4, "start_col": 6, "end_col": 6}, {"order_num": "1.4-4-7-7", "text": "0.04  (3.0 / 84)", "start_row": 4, "end_row": 4, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.5-5-1-1", "text": "label_Catalog", "start_row": 5, "end_row": 5, "start_col": 1, "end_col": 1}, {"order_num": "1.5-5-2-2", "text": "0.78  (49.0 / 63)", "start_row": 5, "end_row": 5, "start_col": 2, "end_col": 2}, {"order_num": "1.5-5-3-3", "text": "0.92  (58.0 / 63)", "start_row": 5, "end_row": 5, "start_col": 3, "end_col": 3}, {"order_num": "1.5-5-4-4", "text": "0.00  (0.0 / 63)", "start_row": 5, "end_row": 5, "start_col": 4, "end_col": 4}, {"order_num": "1.5-5-5-5", "text": "0.00  (0.0 / 63)", "start_row": 5, "end_row": 5, "start_col": 5, "end_col": 5}, {"order_num": "1.5-5-6-6", "text": "0.00  (0.0 / 63)", "start_row": 5, "end_row": 5, "start_col": 6, "end_col": 6}, {"order_num": "1.5-5-7-7", "text": "0.00  (0.0 / 63)", "start_row": 5, "end_row": 5, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.6-6-1-1", "text": "label_Table", "start_row": 6, "end_row": 6, "start_col": 1, "end_col": 1}, {"order_num": "1.6-6-2-2", "text": "1.00  (20.0 / 20)", "start_row": 6, "end_row": 6, "start_col": 2, "end_col": 2}, {"order_num": "1.6-6-3-3", "text": "0.95  (19.0 / 20)", "start_row": 6, "end_row": 6, "start_col": 3, "end_col": 3}, {"order_num": "1.6-6-4-4", "text": "0.42  (8.3 / 20)", "start_row": 6, "end_row": 6, "start_col": 4, "end_col": 4}, {"order_num": "1.6-6-5-5", "text": "0.80  (16.0 / 20)", "start_row": 6, "end_row": 6, "start_col": 5, "end_col": 5}, {"order_num": "1.6-6-6-6", "text": "1.00  (20.0 / 20)", "start_row": 6, "end_row": 6, "start_col": 6, "end_col": 6}, {"order_num": "1.6-6-7-7", "text": "0.95  (19.0 / 20)", "start_row": 6, "end_row": 6, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.7-7-1-1", "text": "label_Figure", "start_row": 7, "end_row": 7, "start_col": 1, "end_col": 1}, {"order_num": "1.7-7-2-2", "text": "0.75  (6.0 / 8)", "start_row": 7, "end_row": 7, "start_col": 2, "end_col": 2}, {"order_num": "1.7-7-3-3", "text": "0.88  (7.0 / 8)", "start_row": 7, "end_row": 7, "start_col": 3, "end_col": 3}, {"order_num": "1.7-7-4-4", "text": "0.75  (6.0 / 8)", "start_row": 7, "end_row": 7, "start_col": 4, "end_col": 4}, {"order_num": "1.7-7-5-5", "text": "0.12  (1.0 / 8)", "start_row": 7, "end_row": 7, "start_col": 5, "end_col": 5}, {"order_num": "1.7-7-6-6", "text": "0.50  (4.0 / 8)", "start_row": 7, "end_row": 7, "start_col": 6, "end_col": 6}, {"order_num": "1.7-7-7-7", "text": "0.75  (6.0 / 8)", "start_row": 7, "end_row": 7, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.8-8-1-1", "text": "label_Formula", "start_row": 8, "end_row": 8, "start_col": 1, "end_col": 1}, {"order_num": "1.8-8-2-2", "text": "0.00  (0.0 / 1)", "start_row": 8, "end_row": 8, "start_col": 2, "end_col": 2}, {"order_num": "1.8-8-3-3", "text": "1.00  (1.0 / 1)", "start_row": 8, "end_row": 8, "start_col": 3, "end_col": 3}, {"order_num": "1.8-8-4-4", "text": "1.00  (1.0 / 1)", "start_row": 8, "end_row": 8, "start_col": 4, "end_col": 4}, {"order_num": "1.8-8-5-5", "text": "1.00  (1.0 / 1)", "start_row": 8, "end_row": 8, "start_col": 5, "end_col": 5}, {"order_num": "1.8-8-6-6", "text": "0.00  (0.0 / 1)", "start_row": 8, "end_row": 8, "start_col": 6, "end_col": 6}, {"order_num": "1.8-8-7-7", "text": "1.00  (1.0 / 1)", "start_row": 8, "end_row": 8, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.9-9-1-1", "text": "label_Code", "start_row": 9, "end_row": 9, "start_col": 1, "end_col": 1}, {"order_num": "1.9-9-2-2", "text": "0.00  (0.0 / 3)", "start_row": 9, "end_row": 9, "start_col": 2, "end_col": 2}, {"order_num": "1.9-9-3-3", "text": "0.00  (0.0 / 3)", "start_row": 9, "end_row": 9, "start_col": 3, "end_col": 3}, {"order_num": "1.9-9-4-4", "text": "0.08  (0.2 / 3)", "start_row": 9, "end_row": 9, "start_col": 4, "end_col": 4}, {"order_num": "1.9-9-5-5", "text": "0.00  (0.0 / 3)", "start_row": 9, "end_row": 9, "start_col": 5, "end_col": 5}, {"order_num": "1.9-9-6-6", "text": "0.00  (0.0 / 3)", "start_row": 9, "end_row": 9, "start_col": 6, "end_col": 6}, {"order_num": "1.9-9-7-7", "text": "0.00  (0.0 / 3)", "start_row": 9, "end_row": 9, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.10-10-1-1", "text": "label_FigureName", "start_row": 10, "end_row": 10, "start_col": 1, "end_col": 1}, {"order_num": "1.10-10-2-2", "text": "0.50  (2.0 / 4)", "start_row": 10, "end_row": 10, "start_col": 2, "end_col": 2}, {"order_num": "1.10-10-3-3", "text": "0.75  (3.0 / 4)", "start_row": 10, "end_row": 10, "start_col": 3, "end_col": 3}, {"order_num": "1.10-10-4-4", "text": "0.00  (0.0 / 4)", "start_row": 10, "end_row": 10, "start_col": 4, "end_col": 4}, {"order_num": "1.10-10-5-5", "text": "0.00  (0.0 / 4)", "start_row": 10, "end_row": 10, "start_col": 5, "end_col": 5}, {"order_num": "1.10-10-6-6", "text": "0.00  (0.0 / 4)", "start_row": 10, "end_row": 10, "start_col": 6, "end_col": 6}, {"order_num": "1.10-10-7-7", "text": "0.00  (0.0 / 4)", "start_row": 10, "end_row": 10, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.11-11-1-1", "text": "label_FigureNote", "start_row": 11, "end_row": 11, "start_col": 1, "end_col": 1}, {"order_num": "1.11-11-2-2", "text": "0.00  (0.0 / 0)", "start_row": 11, "end_row": 11, "start_col": 2, "end_col": 2}, {"order_num": "1.11-11-3-3", "text": "0.00  (0.0 / 0)", "start_row": 11, "end_row": 11, "start_col": 3, "end_col": 3}, {"order_num": "1.11-11-4-4", "text": "0.00  (0.0 / 0)", "start_row": 11, "end_row": 11, "start_col": 4, "end_col": 4}, {"order_num": "1.11-11-5-5", "text": "0.00  (0.0 / 0)", "start_row": 11, "end_row": 11, "start_col": 5, "end_col": 5}, {"order_num": "1.11-11-6-6", "text": "0.00  (0.0 / 0)", "start_row": 11, "end_row": 11, "start_col": 6, "end_col": 6}, {"order_num": "1.11-11-7-7", "text": "0.00  (0.0 / 0)", "start_row": 11, "end_row": 11, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.12-12-1-1", "text": "label_TableName", "start_row": 12, "end_row": 12, "start_col": 1, "end_col": 1}, {"order_num": "1.12-12-2-2", "text": "1.00  (4.0 / 4)", "start_row": 12, "end_row": 12, "start_col": 2, "end_col": 2}, {"order_num": "1.12-12-3-3", "text": "1.00  (4.0 / 4)", "start_row": 12, "end_row": 12, "start_col": 3, "end_col": 3}, {"order_num": "1.12-12-4-4", "text": "0.00  (0.0 / 4)", "start_row": 12, "end_row": 12, "start_col": 4, "end_col": 4}, {"order_num": "1.12-12-5-5", "text": "0.00  (0.0 / 4)", "start_row": 12, "end_row": 12, "start_col": 5, "end_col": 5}, {"order_num": "1.12-12-6-6", "text": "0.00  (0.0 / 4)", "start_row": 12, "end_row": 12, "start_col": 6, "end_col": 6}, {"order_num": "1.12-12-7-7", "text": "0.00  (0.0 / 4)", "start_row": 12, "end_row": 12, "start_col": 7, "end_col": 7}]}, {"cells": [{"order_num": "1.13-13-1-1", "text": "label_TableNote", "start_row": 13, "end_row": 13, "start_col": 1, "end_col": 1}, {"order_num": "1.13-13-2-2", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 2, "end_col": 2}, {"order_num": "1.13-13-3-3", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 3, "end_col": 3}, {"order_num": "1.13-13-4-4", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 4, "end_col": 4}, {"order_num": "1.13-13-5-5", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 5, "end_col": 5}, {"order_num": "1.13-13-6-6", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 6, "end_col": 6}, {"order_num": "1.13-13-7-7", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 7, "end_col": 7}]}]}}], "order_num": null, "element": null}}'
def test_xls_domtree_convert():
    file_name = 'demo.xls'
    stream = load_test_file(file_name)
    converter = XlsExcelConverter(stream)
    domtree = converter.dom_tree_parse()
    dom_tree_json = jsonable_encoder(domtree)
    print(json.dumps(dom_tree_json, ensure_ascii=False))
    assert json.dumps(dom_tree_json, ensure_ascii=False) == xls_dom_tree_json, "生成的DOM树与预期结果不一致"


xlsx_domtree_json = '{"root": {"child": [{"child": [], "order_num": "1", "element": {"block_type": "table", "page_num": [0], "layout_type": "Table", "bbox": [0.0, 0.0, 80.0, 140.0], "rows": [{"cells": [{"order_num": "1.1-1-1-1", "text": "", "start_row": 1, "end_row": 1, "start_col": 1, "end_col": 1}, {"order_num": "1.1-1-2-2", "text": "", "start_row": 1, "end_row": 1, "start_col": 2, "end_col": 2}, {"order_num": "1.1-1-3-3", "text": "", "start_row": 1, "end_row": 1, "start_col": 3, "end_col": 3}, {"order_num": "1.1-1-4-4", "text": "", "start_row": 1, "end_row": 1, "start_col": 4, "end_col": 4}, {"order_num": "1.1-1-5-5", "text": "", "start_row": 1, "end_row": 1, "start_col": 5, "end_col": 5}, {"order_num": "1.1-1-6-6", "text": "", "start_row": 1, "end_row": 1, "start_col": 6, "end_col": 6}, {"order_num": "1.1-1-7-7", "text": "", "start_row": 1, "end_row": 1, "start_col": 7, "end_col": 7}, {"order_num": "1.1-1-8-8", "text": "", "start_row": 1, "end_row": 1, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.2-2-1-1", "text": "", "start_row": 2, "end_row": 2, "start_col": 1, "end_col": 1}, {"order_num": "1.2-2-2-2", "text": "", "start_row": 2, "end_row": 2, "start_col": 2, "end_col": 2}, {"order_num": "1.2-2-3-3", "text": "贝壳", "start_row": 2, "end_row": 2, "start_col": 3, "end_col": 3}, {"order_num": "1.2-2-4-4", "text": "阿里", "start_row": 2, "end_row": 2, "start_col": 4, "end_col": 4}, {"order_num": "1.2-2-5-5", "text": "unstructured", "start_row": 2, "end_row": 2, "start_col": 5, "end_col": 5}, {"order_num": "1.2-2-6-6", "text": "chunkr", "start_row": 2, "end_row": 2, "start_col": 6, "end_col": 6}, {"order_num": "1.2-2-7-7", "text": "庖丁", "start_row": 2, "end_row": 2, "start_col": 7, "end_col": 7}, {"order_num": "1.2-2-8-8", "text": "surya", "start_row": 2, "end_row": 2, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.3-3-1-1", "text": "", "start_row": 3, "end_row": 3, "start_col": 1, "end_col": 1}, {"order_num": "1.3-3-2-2", "text": "label_Text", "start_row": 3, "end_row": 3, "start_col": 2, "end_col": 2}, {"order_num": "1.3-3-3-3", "text": "0.96  (143.5 / 150)", "start_row": 3, "end_row": 3, "start_col": 3, "end_col": 3}, {"order_num": "1.3-3-4-4", "text": "0.97  (145.0 / 150)", "start_row": 3, "end_row": 3, "start_col": 4, "end_col": 4}, {"order_num": "1.3-3-5-5", "text": "0.92  (138.7 / 150)", "start_row": 3, "end_row": 3, "start_col": 5, "end_col": 5}, {"order_num": "1.3-3-6-6", "text": "0.90  (135.0 / 150)", "start_row": 3, "end_row": 3, "start_col": 6, "end_col": 6}, {"order_num": "1.3-3-7-7", "text": "0.97  (146.0 / 150)", "start_row": 3, "end_row": 3, "start_col": 7, "end_col": 7}, {"order_num": "1.3-3-8-8", "text": "0.95  (143.2 / 150)", "start_row": 3, "end_row": 3, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.4-4-1-1", "text": "", "start_row": 4, "end_row": 4, "start_col": 1, "end_col": 1}, {"order_num": "1.4-4-2-2", "text": "label_Title", "start_row": 4, "end_row": 4, "start_col": 2, "end_col": 2}, {"order_num": "1.4-4-3-3", "text": "0.86  (87.0 / 101)", "start_row": 4, "end_row": 4, "start_col": 3, "end_col": 3}, {"order_num": "1.4-4-4-4", "text": "0.80  (81.0 / 101)", "start_row": 4, "end_row": 4, "start_col": 4, "end_col": 4}, {"order_num": "1.4-4-5-5", "text": "0.59  (59.3 / 101)", "start_row": 4, "end_row": 4, "start_col": 5, "end_col": 5}, {"order_num": "1.4-4-6-6", "text": "0.49  (49.0 / 101)", "start_row": 4, "end_row": 4, "start_col": 6, "end_col": 6}, {"order_num": "1.4-4-7-7", "text": "0.00  (0.0 / 101)", "start_row": 4, "end_row": 4, "start_col": 7, "end_col": 7}, {"order_num": "1.4-4-8-8", "text": "0.57  (58.0 / 101)", "start_row": 4, "end_row": 4, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.5-5-1-1", "text": "", "start_row": 5, "end_row": 5, "start_col": 1, "end_col": 1}, {"order_num": "1.5-5-2-2", "text": "label_List", "start_row": 5, "end_row": 5, "start_col": 2, "end_col": 2}, {"order_num": "1.5-5-3-3", "text": "0.00  (0.0 / 84)", "start_row": 5, "end_row": 5, "start_col": 3, "end_col": 3}, {"order_num": "1.5-5-4-4", "text": "0.00  (0.0 / 84)", "start_row": 5, "end_row": 5, "start_col": 4, "end_col": 4}, {"order_num": "1.5-5-5-5", "text": "0.00  (0.0 / 84)", "start_row": 5, "end_row": 5, "start_col": 5, "end_col": 5}, {"order_num": "1.5-5-6-6", "text": "0.04  (3.0 / 84)", "start_row": 5, "end_row": 5, "start_col": 6, "end_col": 6}, {"order_num": "1.5-5-7-7", "text": "0.00  (0.0 / 84)", "start_row": 5, "end_row": 5, "start_col": 7, "end_col": 7}, {"order_num": "1.5-5-8-8", "text": "0.04  (3.0 / 84)", "start_row": 5, "end_row": 5, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.6-6-1-1", "text": "", "start_row": 6, "end_row": 6, "start_col": 1, "end_col": 1}, {"order_num": "1.6-6-2-2", "text": "label_Catalog", "start_row": 6, "end_row": 6, "start_col": 2, "end_col": 2}, {"order_num": "1.6-6-3-3", "text": "0.78  (49.0 / 63)", "start_row": 6, "end_row": 6, "start_col": 3, "end_col": 3}, {"order_num": "1.6-6-4-4", "text": "0.92  (58.0 / 63)", "start_row": 6, "end_row": 6, "start_col": 4, "end_col": 4}, {"order_num": "1.6-6-5-5", "text": "0.00  (0.0 / 63)", "start_row": 6, "end_row": 6, "start_col": 5, "end_col": 5}, {"order_num": "1.6-6-6-6", "text": "0.00  (0.0 / 63)", "start_row": 6, "end_row": 6, "start_col": 6, "end_col": 6}, {"order_num": "1.6-6-7-7", "text": "0.00  (0.0 / 63)", "start_row": 6, "end_row": 6, "start_col": 7, "end_col": 7}, {"order_num": "1.6-6-8-8", "text": "0.00  (0.0 / 63)", "start_row": 6, "end_row": 6, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.7-7-1-1", "text": "", "start_row": 7, "end_row": 7, "start_col": 1, "end_col": 1}, {"order_num": "1.7-7-2-2", "text": "label_Table", "start_row": 7, "end_row": 7, "start_col": 2, "end_col": 2}, {"order_num": "1.7-7-3-3", "text": "1.00  (20.0 / 20)", "start_row": 7, "end_row": 7, "start_col": 3, "end_col": 3}, {"order_num": "1.7-7-4-4", "text": "0.95  (19.0 / 20)", "start_row": 7, "end_row": 7, "start_col": 4, "end_col": 4}, {"order_num": "1.7-7-5-5", "text": "0.42  (8.3 / 20)", "start_row": 7, "end_row": 7, "start_col": 5, "end_col": 5}, {"order_num": "1.7-7-6-6", "text": "0.80  (16.0 / 20)", "start_row": 7, "end_row": 7, "start_col": 6, "end_col": 6}, {"order_num": "1.7-7-7-7", "text": "1.00  (20.0 / 20)", "start_row": 7, "end_row": 7, "start_col": 7, "end_col": 7}, {"order_num": "1.7-7-8-8", "text": "0.95  (19.0 / 20)", "start_row": 7, "end_row": 7, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.8-8-1-1", "text": "", "start_row": 8, "end_row": 8, "start_col": 1, "end_col": 1}, {"order_num": "1.8-8-2-2", "text": "label_Figure", "start_row": 8, "end_row": 8, "start_col": 2, "end_col": 2}, {"order_num": "1.8-8-3-3", "text": "0.75  (6.0 / 8)", "start_row": 8, "end_row": 8, "start_col": 3, "end_col": 3}, {"order_num": "1.8-8-4-4", "text": "0.88  (7.0 / 8)", "start_row": 8, "end_row": 8, "start_col": 4, "end_col": 4}, {"order_num": "1.8-8-5-5", "text": "0.75  (6.0 / 8)", "start_row": 8, "end_row": 8, "start_col": 5, "end_col": 5}, {"order_num": "1.8-8-6-6", "text": "0.12  (1.0 / 8)", "start_row": 8, "end_row": 8, "start_col": 6, "end_col": 6}, {"order_num": "1.8-8-7-7", "text": "0.50  (4.0 / 8)", "start_row": 8, "end_row": 8, "start_col": 7, "end_col": 7}, {"order_num": "1.8-8-8-8", "text": "0.75  (6.0 / 8)", "start_row": 8, "end_row": 8, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.9-9-1-1", "text": "", "start_row": 9, "end_row": 9, "start_col": 1, "end_col": 1}, {"order_num": "1.9-9-2-2", "text": "label_Formula", "start_row": 9, "end_row": 9, "start_col": 2, "end_col": 2}, {"order_num": "1.9-9-3-3", "text": "0.00  (0.0 / 1)", "start_row": 9, "end_row": 9, "start_col": 3, "end_col": 3}, {"order_num": "1.9-9-4-4", "text": "1.00  (1.0 / 1)", "start_row": 9, "end_row": 9, "start_col": 4, "end_col": 4}, {"order_num": "1.9-9-5-5", "text": "1.00  (1.0 / 1)", "start_row": 9, "end_row": 9, "start_col": 5, "end_col": 5}, {"order_num": "1.9-9-6-6", "text": "1.00  (1.0 / 1)", "start_row": 9, "end_row": 9, "start_col": 6, "end_col": 6}, {"order_num": "1.9-9-7-7", "text": "0.00  (0.0 / 1)", "start_row": 9, "end_row": 9, "start_col": 7, "end_col": 7}, {"order_num": "1.9-9-8-8", "text": "1.00  (1.0 / 1)", "start_row": 9, "end_row": 9, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.10-10-1-1", "text": "", "start_row": 10, "end_row": 10, "start_col": 1, "end_col": 1}, {"order_num": "1.10-10-2-2", "text": "label_Code", "start_row": 10, "end_row": 10, "start_col": 2, "end_col": 2}, {"order_num": "1.10-10-3-3", "text": "0.00  (0.0 / 3)", "start_row": 10, "end_row": 10, "start_col": 3, "end_col": 3}, {"order_num": "1.10-10-4-4", "text": "0.00  (0.0 / 3)", "start_row": 10, "end_row": 10, "start_col": 4, "end_col": 4}, {"order_num": "1.10-10-5-5", "text": "0.08  (0.2 / 3)", "start_row": 10, "end_row": 10, "start_col": 5, "end_col": 5}, {"order_num": "1.10-10-6-6", "text": "0.00  (0.0 / 3)", "start_row": 10, "end_row": 10, "start_col": 6, "end_col": 6}, {"order_num": "1.10-10-7-7", "text": "0.00  (0.0 / 3)", "start_row": 10, "end_row": 10, "start_col": 7, "end_col": 7}, {"order_num": "1.10-10-8-8", "text": "0.00  (0.0 / 3)", "start_row": 10, "end_row": 10, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.11-11-1-1", "text": "", "start_row": 11, "end_row": 11, "start_col": 1, "end_col": 1}, {"order_num": "1.11-11-2-2", "text": "label_FigureName", "start_row": 11, "end_row": 11, "start_col": 2, "end_col": 2}, {"order_num": "1.11-11-3-3", "text": "0.50  (2.0 / 4)", "start_row": 11, "end_row": 11, "start_col": 3, "end_col": 3}, {"order_num": "1.11-11-4-4", "text": "0.75  (3.0 / 4)", "start_row": 11, "end_row": 11, "start_col": 4, "end_col": 4}, {"order_num": "1.11-11-5-5", "text": "0.00  (0.0 / 4)", "start_row": 11, "end_row": 11, "start_col": 5, "end_col": 5}, {"order_num": "1.11-11-6-6", "text": "0.00  (0.0 / 4)", "start_row": 11, "end_row": 11, "start_col": 6, "end_col": 6}, {"order_num": "1.11-11-7-7", "text": "0.00  (0.0 / 4)", "start_row": 11, "end_row": 11, "start_col": 7, "end_col": 7}, {"order_num": "1.11-11-8-8", "text": "0.00  (0.0 / 4)", "start_row": 11, "end_row": 11, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.12-12-1-1", "text": "", "start_row": 12, "end_row": 12, "start_col": 1, "end_col": 1}, {"order_num": "1.12-12-2-2", "text": "label_FigureNote", "start_row": 12, "end_row": 12, "start_col": 2, "end_col": 2}, {"order_num": "1.12-12-3-3", "text": "0.00  (0.0 / 0)", "start_row": 12, "end_row": 12, "start_col": 3, "end_col": 3}, {"order_num": "1.12-12-4-4", "text": "0.00  (0.0 / 0)", "start_row": 12, "end_row": 12, "start_col": 4, "end_col": 4}, {"order_num": "1.12-12-5-5", "text": "0.00  (0.0 / 0)", "start_row": 12, "end_row": 12, "start_col": 5, "end_col": 5}, {"order_num": "1.12-12-6-6", "text": "0.00  (0.0 / 0)", "start_row": 12, "end_row": 12, "start_col": 6, "end_col": 6}, {"order_num": "1.12-12-7-7", "text": "0.00  (0.0 / 0)", "start_row": 12, "end_row": 12, "start_col": 7, "end_col": 7}, {"order_num": "1.12-12-8-8", "text": "0.00  (0.0 / 0)", "start_row": 12, "end_row": 12, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.13-13-1-1", "text": "", "start_row": 13, "end_row": 13, "start_col": 1, "end_col": 1}, {"order_num": "1.13-13-2-2", "text": "label_TableName", "start_row": 13, "end_row": 13, "start_col": 2, "end_col": 2}, {"order_num": "1.13-13-3-3", "text": "1.00  (4.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 3, "end_col": 3}, {"order_num": "1.13-13-4-4", "text": "1.00  (4.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 4, "end_col": 4}, {"order_num": "1.13-13-5-5", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 5, "end_col": 5}, {"order_num": "1.13-13-6-6", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 6, "end_col": 6}, {"order_num": "1.13-13-7-7", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 7, "end_col": 7}, {"order_num": "1.13-13-8-8", "text": "0.00  (0.0 / 4)", "start_row": 13, "end_row": 13, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.14-14-1-1", "text": "", "start_row": 14, "end_row": 14, "start_col": 1, "end_col": 1}, {"order_num": "1.14-14-2-2", "text": "label_TableNote", "start_row": 14, "end_row": 14, "start_col": 2, "end_col": 2}, {"order_num": "1.14-14-3-3", "text": "0.00  (0.0 / 4)", "start_row": 14, "end_row": 14, "start_col": 3, "end_col": 3}, {"order_num": "1.14-14-4-4", "text": "0.00  (0.0 / 4)", "start_row": 14, "end_row": 14, "start_col": 4, "end_col": 4}, {"order_num": "1.14-14-5-5", "text": "0.00  (0.0 / 4)", "start_row": 14, "end_row": 14, "start_col": 5, "end_col": 5}, {"order_num": "1.14-14-6-6", "text": "0.00  (0.0 / 4)", "start_row": 14, "end_row": 14, "start_col": 6, "end_col": 6}, {"order_num": "1.14-14-7-7", "text": "0.00  (0.0 / 4)", "start_row": 14, "end_row": 14, "start_col": 7, "end_col": 7}, {"order_num": "1.14-14-8-8", "text": "0.00  (0.0 / 4)", "start_row": 14, "end_row": 14, "start_col": 8, "end_col": 8}]}]}}, {"child": [], "order_num": "1", "element": {"block_type": "table", "page_num": [1], "layout_type": "Table", "bbox": [0.0, 0.0, 80.0, 50.0], "rows": [{"cells": [{"order_num": "1.1-1-1-1", "text": "", "start_row": 1, "end_row": 1, "start_col": 1, "end_col": 1}, {"order_num": "1.1-1-2-2", "text": "", "start_row": 1, "end_row": 1, "start_col": 2, "end_col": 2}, {"order_num": "1.1-1-3-3", "text": "", "start_row": 1, "end_row": 1, "start_col": 3, "end_col": 3}, {"order_num": "1.1-1-4-4", "text": "", "start_row": 1, "end_row": 1, "start_col": 4, "end_col": 4}, {"order_num": "1.1-1-5-5", "text": "", "start_row": 1, "end_row": 1, "start_col": 5, "end_col": 5}, {"order_num": "1.1-1-6-6", "text": "", "start_row": 1, "end_row": 1, "start_col": 6, "end_col": 6}, {"order_num": "1.1-1-7-7", "text": "", "start_row": 1, "end_row": 1, "start_col": 7, "end_col": 7}, {"order_num": "1.1-1-8-8", "text": "", "start_row": 1, "end_row": 1, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.2-2-1-1", "text": "", "start_row": 2, "end_row": 2, "start_col": 1, "end_col": 1}, {"order_num": "1.2-2-2-2", "text": "", "start_row": 2, "end_row": 2, "start_col": 2, "end_col": 2}, {"order_num": "1.2-2-3-3", "text": "贝壳", "start_row": 2, "end_row": 2, "start_col": 3, "end_col": 3}, {"order_num": "1.2-2-4-4", "text": "阿里", "start_row": 2, "end_row": 2, "start_col": 4, "end_col": 4}, {"order_num": "1.2-2-5-5", "text": "unstructured", "start_row": 2, "end_row": 2, "start_col": 5, "end_col": 5}, {"order_num": "1.2-2-6-6", "text": "chunkr", "start_row": 2, "end_row": 2, "start_col": 6, "end_col": 6}, {"order_num": "1.2-2-7-7", "text": "庖丁", "start_row": 2, "end_row": 2, "start_col": 7, "end_col": 7}, {"order_num": "1.2-2-8-8", "text": "surya", "start_row": 2, "end_row": 2, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.3-3-1-1", "text": "", "start_row": 3, "end_row": 3, "start_col": 1, "end_col": 1}, {"order_num": "1.3-3-2-2", "text": "block切分准确率", "start_row": 3, "end_row": 3, "start_col": 2, "end_col": 2}, {"order_num": "1.3-3-3-3", "text": "0.96  (425 / 442)", "start_row": 3, "end_row": 3, "start_col": 3, "end_col": 3}, {"order_num": "1.3-3-4-4", "text": "0.96  (427 / 442)", "start_row": 3, "end_row": 3, "start_col": 4, "end_col": 4}, {"order_num": "1.3-3-5-5", "text": "0.78  (353 / 442)", "start_row": 3, "end_row": 3, "start_col": 5, "end_col": 5}, {"order_num": "1.3-3-6-6", "text": "0.70  (313 / 442)", "start_row": 3, "end_row": 3, "start_col": 6, "end_col": 6}, {"order_num": "1.3-3-7-7", "text": "0.94  (419 / 442)", "start_row": 3, "end_row": 3, "start_col": 7, "end_col": 7}, {"order_num": "1.3-3-8-8", "text": "<<.053", "start_row": 3, "end_row": 3, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.4-4-1-1", "text": "", "start_row": 4, "end_row": 4, "start_col": 1, "end_col": 1}, {"order_num": "1.4-4-2-2", "text": "版面元素准确率", "start_row": 4, "end_row": 4, "start_col": 2, "end_col": 2}, {"order_num": "1.4-4-3-3", "text": "0.70  (311.5 / 442)", "start_row": 4, "end_row": 4, "start_col": 3, "end_col": 3}, {"order_num": "1.4-4-4-4", "text": "0.72  (318.0 / 442)", "start_row": 4, "end_row": 4, "start_col": 4, "end_col": 4}, {"order_num": "1.4-4-5-5", "text": "0.48  (213.6 / 442)", "start_row": 4, "end_row": 4, "start_col": 5, "end_col": 5}, {"order_num": "1.4-4-6-6", "text": "0.46  (205.0 / 442)", "start_row": 4, "end_row": 4, "start_col": 6, "end_col": 6}, {"order_num": "1.4-4-7-7", "text": "0.38  (170.0 / 442)", "start_row": 4, "end_row": 4, "start_col": 7, "end_col": 7}, {"order_num": "1.4-4-8-8", "text": "0.52  (230.2 / 442)", "start_row": 4, "end_row": 4, "start_col": 8, "end_col": 8}]}, {"cells": [{"order_num": "1.5-5-1-1", "text": "", "start_row": 5, "end_row": 5, "start_col": 1, "end_col": 1}, {"order_num": "1.5-5-2-2", "text": "层级结构准确率", "start_row": 5, "end_row": 5, "start_col": 2, "end_col": 2}, {"order_num": "1.5-5-3-3", "text": "0.80  (336 / 422)", "start_row": 5, "end_row": 5, "start_col": 3, "end_col": 3}, {"order_num": "1.5-5-4-4", "text": "0.77  (327 / 422)", "start_row": 5, "end_row": 5, "start_col": 4, "end_col": 4}, {"order_num": "1.5-5-5-5", "text": "0.27  (112 / 422)", "start_row": 5, "end_row": 5, "start_col": 5, "end_col": 5}, {"order_num": "1.5-5-6-6", "text": "0.00  (0 / 422)", "start_row": 5, "end_row": 5, "start_col": 6, "end_col": 6}, {"order_num": "1.5-5-7-7", "text": "0.56  (237 / 422)", "start_row": 5, "end_row": 5, "start_col": 7, "end_col": 7}, {"order_num": "1.5-5-8-8", "text": "-", "start_row": 5, "end_row": 5, "start_col": 8, "end_col": 8}]}]}}], "order_num": null, "element": null}}'
def test_xlsx_domtree_convert():
    file_name = 'demo.xlsx'
    stream = load_test_file(file_name)
    converter = XlsxExcelConverter(stream)
    domtree = converter.dom_tree_parse()
    dom_tree_json = jsonable_encoder(domtree)
    print(json.dumps(dom_tree_json, ensure_ascii=False))
    assert json.dumps(dom_tree_json, ensure_ascii=False) == xlsx_domtree_json, "生成的DOM树与预期结果不一致"